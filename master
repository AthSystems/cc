local modem = peripheral.find("modem") or error("No modem", 0)
rednet.open(peripheral.getName(modem))

local nodeDrills = 0
local drill_state = false
local kw_drills_frontward = "frontward"
local kw_drills_fb_frontward = "DFF"
local kw_drills_backward = "backward"
local kw_drills_fb_backward = "DFB"

local nodePusher = 5
local pusher_level = 0
local kw_pusher_5m = "5m"
local kw_pusher_fb_5m = "LVL5"
local kw_pusher_1m = "1m"
local kw_pusher_fb_1m = "LVL"
local kw_pusher_ground = "0m"
local kw_pusher_fb_ground = "LVL0"
local kw_pusher_fb_top = "LVL15"

function send(id, message)
    print("Sending to " .. id .. ": " .. message)
    rednet.send(id, message)
end

function waitForReply(waitFor)
    while true do
        local _, reply = rednet.receive(5)
        if reply and string.find(reply, waitFor) then
            print(reply)
            break
        end
    end
end

function sendAndWait(id, message, waitFor)
    send(id, message)
    waitForReplay(waitFor)
end

function stop()
    print("Stopping farm")
end

function toggleDrills()
    if drill_state then
        sendAndWait(nodeDrills, kw_drills_backward,kw_drills_fb_backward)
    else 
        sendAndWait(nodeDrills, kw_drills_frontward,kw_drills_fb_frontward)
    end
    drill_state = not drill_state
end


function move_block_pusher(lvl)
    if lvl == 1 then
        if pusher_lvl >= 5 and pusher_lvl <= 15 then
            send(nodePusher, kw_pusher_1m)
            if pusher_lvl == 14 then
                waitFor(kw_pusher_fb_top)
            else
                waitFor(kw_pusher_fb_1m)
            pusher_lvl = pusher_lvl + 1
        end
    elseif lvl == 5 then
        if pusher_lvl == 0 then
            sendAndWait(nodePusher, kw_pusher_5m, kw_pusher_fb_5m)
            pusher_lvl = 5
        end
    elseif lvl == 0 then
        if pusher_lvl == 15 then
            sendAndWait(nodePusher, kw_pusher_ground, kw_pusher_fb_ground)
            pusher_lvl = 0
        end
    end
end
        

sleep(10)
--5
move_block_pusher(5)
sleep(3)
--6
move_block_pusher(1)
sleep(3)
--6
move_block_pusher(5)
sleep(3)
--7
move_block_pusher(1)
-- 8 -> 15
move_block_pusher(1)
move_block_pusher(1)
move_block_pusher(1)
move_block_pusher(1)
move_block_pusher(1)
move_block_pusher(1)
move_block_pusher(1)

--0
move_block_pusher(0)
move_block_pusher(1)


