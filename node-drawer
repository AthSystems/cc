
local drawer_side = "back"
local threshold = 90


local drawer = peripheral.wrap(drawer_side) or error ("No drawer found at " .. drawer_side, 0)

local modem = peripheral.find("modem") or error("No modem", 0)
rednet.open(peripheral.getName(modem))

local master_id = 1
local monitor_id = 100
local node_name = "drawerNode"
local slot_check = 1


function prompt(msg)
    print("[" .. os.date("%H:%M:%S") .. "] " .. msg)
end

function getItemName()
  return drawer.getItemDetail(1)["displayName"]
end

function getCount()
  return drawer.getItemDetail(1)["count"]
end

function getItemLimit()
  return drawer.getItemLimit(1)
end

function getPercentFill()
  local limit = drawer.getItemLimit(1)
  local count = drawer.getItemDetail(1)["count"]
  return (count/limit) * 100
end

function getDrawerData()
  return {getItemName(), getPercentFill(), getCount(), getItemLimit()}
end

prompt("Node ".. node_name .. " : ready.")


function main_loop()
  while true do 
    if getPercentFill() >= threshold then
      rednet.send(master_id, {"stop", getPercentFill()})
    else 
      rednet.send(master_id, {"continue", getPercentFill()})
    end
  
    rednet.send(monitor_id, getDrawerData())
    prompt(table.unpack(getDrawerData()))
    sleep(1)
  
  end
end

function listening()
  while true do
    local senderID, msg = rednet.receive()
    if msg == "ping" then
        prompt("ping received. Sending pong")
        rednet.send(senderID, "pong")
    end
  end
end


parallel.waitForAll(listening, main_loop)



